<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Chrome扩展通信 | 前端文档</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.c16151cb.css" as="style"><link rel="preload" href="/assets/js/app.d8d2a0bb.js" as="script"><link rel="preload" href="/assets/js/2.72d74e75.js" as="script"><link rel="preload" href="/assets/js/88.3daecc66.js" as="script"><link rel="prefetch" href="/assets/js/10.cf536c6e.js"><link rel="prefetch" href="/assets/js/100.c25647d5.js"><link rel="prefetch" href="/assets/js/101.e37e89a3.js"><link rel="prefetch" href="/assets/js/102.1d078254.js"><link rel="prefetch" href="/assets/js/103.f7145785.js"><link rel="prefetch" href="/assets/js/104.09261142.js"><link rel="prefetch" href="/assets/js/11.4fc5fc97.js"><link rel="prefetch" href="/assets/js/12.f434524e.js"><link rel="prefetch" href="/assets/js/13.da6877eb.js"><link rel="prefetch" href="/assets/js/14.14ab89d2.js"><link rel="prefetch" href="/assets/js/15.3e7434dc.js"><link rel="prefetch" href="/assets/js/16.b71d2e49.js"><link rel="prefetch" href="/assets/js/17.b0ce1778.js"><link rel="prefetch" href="/assets/js/18.6fa35daa.js"><link rel="prefetch" href="/assets/js/19.ff1ddec4.js"><link rel="prefetch" href="/assets/js/20.e4d72525.js"><link rel="prefetch" href="/assets/js/21.4d0efa1c.js"><link rel="prefetch" href="/assets/js/22.c44c384b.js"><link rel="prefetch" href="/assets/js/23.9a2877af.js"><link rel="prefetch" href="/assets/js/24.360e6d19.js"><link rel="prefetch" href="/assets/js/25.e17e7858.js"><link rel="prefetch" href="/assets/js/26.b92608e0.js"><link rel="prefetch" href="/assets/js/27.a7d4e0dd.js"><link rel="prefetch" href="/assets/js/28.bfb6bcc2.js"><link rel="prefetch" href="/assets/js/29.bf390e39.js"><link rel="prefetch" href="/assets/js/3.e9c89680.js"><link rel="prefetch" href="/assets/js/30.8a7d3e7f.js"><link rel="prefetch" href="/assets/js/31.c3b06015.js"><link rel="prefetch" href="/assets/js/32.0c2939d3.js"><link rel="prefetch" href="/assets/js/33.fa4983ed.js"><link rel="prefetch" href="/assets/js/34.0bc17c61.js"><link rel="prefetch" href="/assets/js/35.1d9415b5.js"><link rel="prefetch" href="/assets/js/36.a2806d43.js"><link rel="prefetch" href="/assets/js/37.b51eeb79.js"><link rel="prefetch" href="/assets/js/38.c22e3ed1.js"><link rel="prefetch" href="/assets/js/39.53458df7.js"><link rel="prefetch" href="/assets/js/4.cde39425.js"><link rel="prefetch" href="/assets/js/40.651682e8.js"><link rel="prefetch" href="/assets/js/41.aebdf2fa.js"><link rel="prefetch" href="/assets/js/42.bc98c52a.js"><link rel="prefetch" href="/assets/js/43.484d01b2.js"><link rel="prefetch" href="/assets/js/44.a428ddbd.js"><link rel="prefetch" href="/assets/js/45.6d4d1019.js"><link rel="prefetch" href="/assets/js/46.7e0df30c.js"><link rel="prefetch" href="/assets/js/47.f43ef89c.js"><link rel="prefetch" href="/assets/js/48.f0c83a91.js"><link rel="prefetch" href="/assets/js/49.7689fff4.js"><link rel="prefetch" href="/assets/js/5.3988f2a7.js"><link rel="prefetch" href="/assets/js/50.3adc84a7.js"><link rel="prefetch" href="/assets/js/51.6f405f0e.js"><link rel="prefetch" href="/assets/js/52.8cacdf11.js"><link rel="prefetch" href="/assets/js/53.a5812d23.js"><link rel="prefetch" href="/assets/js/54.0c04368f.js"><link rel="prefetch" href="/assets/js/55.fbc6c3c7.js"><link rel="prefetch" href="/assets/js/56.7811d98a.js"><link rel="prefetch" href="/assets/js/57.31eceea4.js"><link rel="prefetch" href="/assets/js/58.ac302dd8.js"><link rel="prefetch" href="/assets/js/59.46f9fff4.js"><link rel="prefetch" href="/assets/js/6.3028bb71.js"><link rel="prefetch" href="/assets/js/60.205b17bd.js"><link rel="prefetch" href="/assets/js/61.f68e6746.js"><link rel="prefetch" href="/assets/js/62.95ddb372.js"><link rel="prefetch" href="/assets/js/63.73425831.js"><link rel="prefetch" href="/assets/js/64.da05ef5f.js"><link rel="prefetch" href="/assets/js/65.6550e3b0.js"><link rel="prefetch" href="/assets/js/66.d9ef6fa7.js"><link rel="prefetch" href="/assets/js/67.ebe75aad.js"><link rel="prefetch" href="/assets/js/68.39c19da4.js"><link rel="prefetch" href="/assets/js/69.53c7de37.js"><link rel="prefetch" href="/assets/js/7.57913225.js"><link rel="prefetch" href="/assets/js/70.7e276bbb.js"><link rel="prefetch" href="/assets/js/71.d72f9f89.js"><link rel="prefetch" href="/assets/js/72.8aaf78f1.js"><link rel="prefetch" href="/assets/js/73.d1ddf670.js"><link rel="prefetch" href="/assets/js/74.bf4e85f1.js"><link rel="prefetch" href="/assets/js/75.e9547c4f.js"><link rel="prefetch" href="/assets/js/76.c2abb8bd.js"><link rel="prefetch" href="/assets/js/77.f162bb01.js"><link rel="prefetch" href="/assets/js/78.2780caa3.js"><link rel="prefetch" href="/assets/js/79.8be5fdb6.js"><link rel="prefetch" href="/assets/js/8.0bca1ec9.js"><link rel="prefetch" href="/assets/js/80.2fb0101e.js"><link rel="prefetch" href="/assets/js/81.209917c2.js"><link rel="prefetch" href="/assets/js/82.04ba13ae.js"><link rel="prefetch" href="/assets/js/83.3d55152d.js"><link rel="prefetch" href="/assets/js/84.12f53b61.js"><link rel="prefetch" href="/assets/js/85.37fb18f7.js"><link rel="prefetch" href="/assets/js/86.29a425ed.js"><link rel="prefetch" href="/assets/js/87.90b95889.js"><link rel="prefetch" href="/assets/js/89.c8e4ec1a.js"><link rel="prefetch" href="/assets/js/9.b58cbdb9.js"><link rel="prefetch" href="/assets/js/90.a0352888.js"><link rel="prefetch" href="/assets/js/91.d3d51315.js"><link rel="prefetch" href="/assets/js/92.e1861fd3.js"><link rel="prefetch" href="/assets/js/93.ca928336.js"><link rel="prefetch" href="/assets/js/94.ff60a408.js"><link rel="prefetch" href="/assets/js/95.5d1c4712.js"><link rel="prefetch" href="/assets/js/96.3be6aa08.js"><link rel="prefetch" href="/assets/js/97.b1bb574e.js"><link rel="prefetch" href="/assets/js/98.9acfeac6.js"><link rel="prefetch" href="/assets/js/99.774eb619.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c16151cb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">前端文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="front end" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="front end" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/html/" class="nav-link">
  html
</a></li><li class="dropdown-item"><!----> <a href="/frontend/css/" class="nav-link">
  css
</a></li><li class="dropdown-item"><!----> <a href="/frontend/js/" class="nav-link">
  js
</a></li></ul></div></div><div class="nav-item"><a href="/interview/" class="nav-link">
  面试题
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  博文
</a></div><div class="nav-item"><a href="https://github.com/305810827" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="front end" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="front end" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/html/" class="nav-link">
  html
</a></li><li class="dropdown-item"><!----> <a href="/frontend/css/" class="nav-link">
  css
</a></li><li class="dropdown-item"><!----> <a href="/frontend/js/" class="nav-link">
  js
</a></li></ul></div></div><div class="nav-item"><a href="/interview/" class="nav-link">
  面试题
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  博文
</a></div><div class="nav-item"><a href="https://github.com/305810827" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>每日一题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/question/违规取证项目.html" class="sidebar-link">违规取证项目</a></li><li><a href="/question/添加dns解析缓存，加速页面访问.html" class="sidebar-link">添加dns解析缓存，加速页面访问</a></li><li><a href="/question/提取网站正文内容.html" class="sidebar-link">提取网站正文内容</a></li><li><a href="/question/使用puppeteer爬虫的总结.html" class="sidebar-link">使用puppeteer爬虫的总结</a></li><li><a href="/question/wanted-order.html" class="sidebar-link">wanted-order</a></li><li><a href="/question/submodule.html" class="sidebar-link">submodule</a></li><li><a href="/question/resolve.html" class="sidebar-link">resolve</a></li><li><a href="/question/plugins.html" class="sidebar-link">plugins</a></li><li><a href="/question/load、domcontentloaded.html" class="sidebar-link">load、domcontentloaded</a></li><li><a href="/question/linux install puppeteer error.html" class="sidebar-link">linux install puppeteer error</a></li><li><a href="/question/git设定不合并的文件.html" class="sidebar-link">git设定不合并的文件</a></li><li><a href="/question/entry和output.html" class="sidebar-link">entry和output</a></li><li><a href="/question/context.html" class="sidebar-link">context</a></li><li><a href="/question/Module.html" class="sidebar-link">Module</a></li><li><a href="/question/IP地址.html" class="sidebar-link">IP地址</a></li><li><a href="/question/Chrome扩展通信1.html" class="sidebar-link">Chrome扩展通信1</a></li><li><a href="/question/Chrome扩展通信.html" class="active sidebar-link">Chrome扩展通信</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/question/Chrome扩展通信.html#chrome扩展的5种js" class="sidebar-link">chrome扩展的5种js</a></li><li class="sidebar-sub-header"><a href="/question/Chrome扩展通信.html#chrome插件提供的2种额外的通信方式" class="sidebar-link">Chrome插件提供的2种额外的通信方式</a></li><li class="sidebar-sub-header"><a href="/question/Chrome扩展通信.html#通信接口使用限制" class="sidebar-link">通信接口使用限制</a></li><li class="sidebar-sub-header"><a href="/question/Chrome扩展通信.html#一次性请求" class="sidebar-link">一次性请求</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/question/Chrome扩展通信.html#扩展程序-popup、background-向content-script一次性通信" class="sidebar-link">扩展程序（popup、background）向content-script一次性通信</a></li><li class="sidebar-sub-header"><a href="/question/Chrome扩展通信.html#content-script主动向扩展程序-background、popup-一次性通信" class="sidebar-link">content-script主动向扩展程序（background、popup）一次性通信</a></li><li class="sidebar-sub-header"><a href="/question/Chrome扩展通信.html#页面脚本-包括inject-script-和content-script之间一次性通信" class="sidebar-link">页面脚本（包括inject-script）和content-script之间一次性通信</a></li></ul></li><li class="sidebar-sub-header"><a href="/question/Chrome扩展通信.html#长时效连接" class="sidebar-link">长时效连接</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/question/Chrome扩展通信.html#chrome-tabs-connect和chrome-runtime-connect-长时效连接通信示例" class="sidebar-link">chrome.tabs.connect和chrome.runtime.connect 长时效连接通信示例</a></li><li class="sidebar-sub-header"><a href="/question/Chrome扩展通信.html#postmessage和messagechannel-长时效连接通信" class="sidebar-link">postMessage和messageChannel 长时效连接通信</a></li></ul></li></ul></li><li><a href="/question/--unsafe-perm.html" class="sidebar-link">--unsafe-perm</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="chrome扩展通信"><a href="#chrome扩展通信" class="header-anchor">#</a> Chrome扩展通信</h1> <h2 id="chrome扩展的5种js"><a href="#chrome扩展的5种js" class="header-anchor">#</a> chrome扩展的5种js</h2> <table><thead><tr><th>js类型</th> <th>介绍</th></tr></thead> <tbody><tr><td>popup</td> <td>单击插件图标后的弹窗中的js，由于单击图标打开popup，焦点离开又立即关闭，生命周期一般很短。</td></tr> <tr><td>content-script</td> <td>与页面共享DOM，但是不共享JS，可访问部分chrome扩展API。</td></tr> <tr><td>background</td> <td>权限最高，几乎可调用所有Chrome扩展API（除了devTools），且可以无限制跨域。生命周期最长，跟随浏览器开关。</td></tr> <tr><td>injected-script</td> <td>通过DOM操作的方式向页面注入的一种JS，和原始页面共享js（即可访问原始页面变量，方法等），无法访问Chrome扩展API。</td></tr> <tr><td>devtools</td> <td>每打开一个开发者工具窗口，都会创建devtools的页面的实例，F12窗口关闭，页面也随之关闭，故devtools的生命周期和devtools窗口是一致的。可访问一组特有的DevTools API（background都无权访问）：chrome.devtools.panels（面板相关）；chrome.devtools.inspectedWindow（获取被审查窗口的相关信息）；chrome.devtools.network（获取有关网络请求信息）。</td></tr></tbody></table> <h2 id="chrome插件提供的2种额外的通信方式"><a href="#chrome插件提供的2种额外的通信方式" class="header-anchor">#</a> Chrome插件提供的2种额外的通信方式</h2> <ol><li><code>chrome.tabs.sendMessage</code>和<code>chrome.runtime.sendMessage</code> 用于简单的一次性请求;</li> <li><code>chrome.tabs.connect</code>和<code>chrome.runtime.connect</code>，用于长时效连接。</li></ol> <h2 id="通信接口使用限制"><a href="#通信接口使用限制" class="header-anchor">#</a> 通信接口使用限制</h2> <table><thead><tr><th></th> <th>inject-script</th> <th>content-script</th> <th>popup-js</th> <th>background</th></tr></thead> <tbody><tr><td>inject-script</td> <td>-</td> <td>window.postMessage</td> <td>-</td> <td>-</td></tr> <tr><td>content-script</td> <td>window.postMessage</td> <td>-</td> <td>chrome.runtime.sendMessage chrome.runtime.connect</td> <td>chrome.runtime.sendMessage chrome.runtime.connect</td></tr> <tr><td>popup-js</td> <td>-</td> <td>chrome.tabs.sendMessage chrome.tabs.connect</td> <td>-</td> <td>chrome.runtime.sendMessage chrome.runtime.connect</td></tr> <tr><td>background-js</td> <td>-</td> <td>chrome.tabs.sendMessage chrome.tabs.connect</td> <td>chrome.tabs.sendMessage chrome.tabs.connect</td> <td>-</td></tr> <tr><td>devtools-js</td> <td>chrome.devtools.inspectedWindow.eval</td> <td></td> <td>chrome.runtime.sendMessage</td> <td>chrome.runtime.sendMessage</td></tr></tbody></table> <blockquote><p><code>chrome.runtime.onMessageExternal</code> 接口用于扩展间通信，与<code>chrome.tabs.sendMessage</code> 用法类似。</p></blockquote> <h2 id="一次性请求"><a href="#一次性请求" class="header-anchor">#</a> 一次性请求</h2> <p>一次性请求类似于HTTP请求，包含一次请求和一次返回，且如果接收方不在线，就会出现请求失败；</p> <h3 id="扩展程序-popup、background-向content-script一次性通信"><a href="#扩展程序-popup、background-向content-script一次性通信" class="header-anchor">#</a> 扩展程序（popup、background）向content-script一次性通信</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//popup.js发送</span>
<span class="token keyword">function</span> <span class="token function">sendToContentScript</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">active</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">currentWindow</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">tabs</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>tabs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> message<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">sendToContentScript</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">cmd</span><span class="token operator">:</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span><span class="token string">'popup_to_content'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>   <span class="token operator">*</span><span class="token comment">// {res:'content_to_popup'}*</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// content_script.js接收</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>   <span class="token operator">*</span><span class="token comment">// {cmd:'test', value:'popup_to_content'}*</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>cmd <span class="token operator">===</span> <span class="token string">'content_to_bg'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">res</span><span class="token operator">:</span><span class="token string">'content_to_popup'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	  <span class="token comment">// 若异步使用sendResponse，需添加return true*</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>双方通信直接发送的都是JSON对象，不是JSON字符串，所以无需解析，很方便（当然也可以直接发送字符串）</p> <h3 id="content-script主动向扩展程序-background、popup-一次性通信"><a href="#content-script主动向扩展程序-background、popup-一次性通信" class="header-anchor">#</a> content-script主动向扩展程序（background、popup）一次性通信</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// content_script.js发送</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">cmd</span><span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span><span class="token string">'content_to_bg'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//{res:'bg_to_content'}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// background.js接收</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// {cmd: 'test', value:'content_to_bg'}</span>
	<span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">res</span><span class="token operator">:</span><span class="token string">'bg_to_content'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>注意事项</strong>：</p> <ul><li><code>content_scripts</code>向<code>popup</code>主动发消息的前提是<code>popup</code>处于打开状态，否则需要利用<code>background</code>作中转；</li> <li>使用<code>chrome.runtime.sendMessage</code>后无论是否需要回应，接收方都需调用<code>sendReponse</code>反馈，若不调用则<strong>发送方</strong>就会报错：</li> <li>如果<code>background</code>和<code>popup</code>同时监听，那么它们都可以同时收到消息，但是只有一个可以<code>sendResponse</code>，一个先发送了，那么另外一个再发送就<strong>无效</strong>；</li></ul> <h3 id="页面脚本-包括inject-script-和content-script之间一次性通信"><a href="#页面脚本-包括inject-script-和content-script之间一次性通信" class="header-anchor">#</a> 页面脚本（包括inject-script）和content-script之间一次性通信</h3> <p>由于inject-script和content-script内均可获取到原始页面的window对象，故可通过<code>window.postMessage</code>来进行通信。该方法还可规避跨域的限制,可以在任意页面之间进行通信。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">//inject-script</span>
window<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">cmd</span><span class="token operator">:</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span><span class="token literal-property property">value</span><span class="token operator">:</span><span class="token string">&quot;inject_to_content&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span>

<span class="token comment">//content-script</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span>    <span class="token comment">//{cmd:&quot;test&quot;,value:&quot;inject_to_content&quot;}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="长时效连接"><a href="#长时效连接" class="header-anchor">#</a> 长时效连接</h2> <p>长连类似 <code>WebSocket</code>，建立连接后会一直保持，双方可以随时互发消息。</p> <h3 id="chrome-tabs-connect和chrome-runtime-connect-长时效连接通信示例"><a href="#chrome-tabs-connect和chrome-runtime-connect-长时效连接通信示例" class="header-anchor">#</a> <code>chrome.tabs.connect</code>和<code>chrome.runtime.connect</code> 长时效连接通信示例</h3> <p>扩展程序和web页面之间建立长连接，只需要从一端建立就可以了。
<strong>在popup或js或background发起连接请求：</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//popup.js或background.js 发起连接需要指定发送到某个标签页</span>
chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">active</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">currentWindow</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">tabs</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> port <span class="token operator">=</span> chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>tabs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'popup'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//向指定tabd页发起连接请求</span>
	port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">cmd</span><span class="token operator">:</span> <span class="token string">'popup-connect'</span><span class="token punctuation">,</span><span class="token literal-property property">value</span><span class="token operator">:</span><span class="token string">'extension'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	port<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>cmd <span class="token operator">===</span> <span class="token string">'connected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">//do something</span>
			port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">cmd</span><span class="token operator">:</span> <span class="token string">'done'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>在content-script发起连接和监听消息：</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// content-script直接建立长链接</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'content'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">cmd</span><span class="token operator">:</span> <span class="token string">'cnt-connect'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
port<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>cmd <span class="token operator">===</span> <span class="token string">'connected'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">//do something</span>
		port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">cmd</span><span class="token operator">:</span> <span class="token string">'done'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>任意一端监听连接请求：</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onConnect<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token parameter">port</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>port<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'popup'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		port<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>cmd<span class="token operator">==</span> <span class="token string">'popup-connect'</span><span class="token punctuation">)</span> port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">cmd</span><span class="token operator">:</span> <span class="token string">'connnected'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>port<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'content'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token operator">...</span><span class="token operator">...</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="postmessage和messagechannel-长时效连接通信"><a href="#postmessage和messagechannel-长时效连接通信" class="header-anchor">#</a> <code>postMessage</code>和<code>messageChannel</code> 长时效连接通信</h3> <ul><li>同一MessageChannel实例下的port1和port2两个对象可以通过<code>postMessage</code>和<code>onmessage</code>方法相互发送和接收消息;</li> <li>port1和port2是MessagePort实例，MessagePort继承了Transferable接口，可在不同可执行上下文之间传递。</li> <li><code>window.postMessage(message, targetOrigin, [transfer])</code>,第三个参数可以用来传递Transferable对象</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//inject-script</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>port1<span class="token punctuation">,</span>port2<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;load&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
port1<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
window<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'来自inject_script的信息'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>port2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//content-script</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">e</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  e<span class="token punctuation">.</span>port<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'来自content-script的信息'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/question/Chrome扩展通信1.html" class="prev">
        Chrome扩展通信1
      </a></span> <span class="next"><a href="/question/--unsafe-perm.html">
        --unsafe-perm
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d8d2a0bb.js" defer></script><script src="/assets/js/2.72d74e75.js" defer></script><script src="/assets/js/88.3daecc66.js" defer></script>
  </body>
</html>
